name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup BEAM (Erlang + Gleam)
      uses: erlef/setup-beam@v1
      with:
        otp-version: '27'
        gleam-version: '1.13.0'
        rebar3-version: '3.25.0'

    - name: Setup Deno
      uses: denoland/setup-deno@v2
      with:
        deno-version: v2.x

    - name: Cache Gleam dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/gleam
          build
        key: ${{ runner.os }}-gleam-release-${{ hashFiles('manifest.toml') }}
        restore-keys: |
          ${{ runner.os }}-gleam-release-
          ${{ runner.os }}-gleam-

    - name: Download dependencies
      run: gleam deps download

    - name: Build Gleam to JavaScript
      run: gleam build --target javascript

    - name: Extract version from gleam.toml
      id: version
      run: |
        VERSION=$(grep '^version' gleam.toml | sed 's/version = "\(.*\)"/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"

    - name: Compile binaries for all platforms
      run: |
        mkdir -p dist
        VERSION=${{ steps.version.outputs.version }}

        # Linux x64
        deno compile --no-check --allow-read --allow-write \
          --target x86_64-unknown-linux-gnu \
          --output dist/caffeine-${VERSION}-linux-x64 main.mjs

        # Linux ARM64
        deno compile --no-check --allow-read --allow-write \
          --target aarch64-unknown-linux-gnu \
          --output dist/caffeine-${VERSION}-linux-arm64 main.mjs

        # macOS x64
        deno compile --no-check --allow-read --allow-write \
          --target x86_64-apple-darwin \
          --output dist/caffeine-${VERSION}-macos-x64 main.mjs

        # macOS ARM64 (Apple Silicon)
        deno compile --no-check --allow-read --allow-write \
          --target aarch64-apple-darwin \
          --output dist/caffeine-${VERSION}-macos-arm64 main.mjs

        # Windows x64
        deno compile --no-check --allow-read --allow-write \
          --target x86_64-pc-windows-msvc \
          --output dist/caffeine-${VERSION}-windows-x64.exe main.mjs

    - name: Create archives
      run: |
        cd dist
        VERSION=${{ steps.version.outputs.version }}

        # Linux archives
        tar -czvf caffeine-${VERSION}-linux-x64.tar.gz caffeine-${VERSION}-linux-x64
        tar -czvf caffeine-${VERSION}-linux-arm64.tar.gz caffeine-${VERSION}-linux-arm64

        # macOS archives
        tar -czvf caffeine-${VERSION}-macos-x64.tar.gz caffeine-${VERSION}-macos-x64
        tar -czvf caffeine-${VERSION}-macos-arm64.tar.gz caffeine-${VERSION}-macos-arm64

        # Windows archive
        zip caffeine-${VERSION}-windows-x64.zip caffeine-${VERSION}-windows-x64.exe

    - name: Generate SHA256 checksums
      run: |
        cd dist
        VERSION=${{ steps.version.outputs.version }}

        sha256sum \
          caffeine-${VERSION}-linux-x64.tar.gz \
          caffeine-${VERSION}-linux-arm64.tar.gz \
          caffeine-${VERSION}-macos-x64.tar.gz \
          caffeine-${VERSION}-macos-arm64.tar.gz \
          caffeine-${VERSION}-windows-x64.zip \
          > caffeine-${VERSION}-checksums.sha256

        echo "Generated checksums:"
        cat caffeine-${VERSION}-checksums.sha256

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        generate_release_notes: true
        files: |
          dist/caffeine-${{ steps.version.outputs.version }}-linux-x64.tar.gz
          dist/caffeine-${{ steps.version.outputs.version }}-linux-arm64.tar.gz
          dist/caffeine-${{ steps.version.outputs.version }}-macos-x64.tar.gz
          dist/caffeine-${{ steps.version.outputs.version }}-macos-arm64.tar.gz
          dist/caffeine-${{ steps.version.outputs.version }}-windows-x64.zip
          dist/caffeine-${{ steps.version.outputs.version }}-checksums.sha256
