name: release
on:
  push:
    tags: ["v*"]
  workflow_dispatch: {}

permissions:
  contents: write   # required for uploading release assets

jobs:
  build-and-release:
    strategy:
      matrix:
        os: [ubuntu-22.04, macos-15]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14

      - name: Enable Nix cache (faster builds)
        uses: DeterminateSystems/magic-nix-cache-action@v6

      # Optional: ensure the attribute builds cleanly first (keeps logs clearer)
      - name: Bundle portable artifact
        shell: bash
        run: |
          set -euxo pipefail
          sys=$(nix eval --raw --impure --expr builtins.currentSystem || echo unknown)
          out="caffeine-${sys}.tar.gz"

          # nix bundle writes to a symlink result by default, not --out-file
          nix bundle .#caffeine --bundler github:NixOS/bundlers#tarball --out-link bundle-result

          # Rename the generated file to a predictable name
          mv bundle-result "${out}"

          # Quick smoke test
          tmpdir=$(mktemp -d)
          tar -C "$tmpdir" -xzf "${out}"
          if [[ -x "$tmpdir/bin/caffeine" ]]; then
            "$tmpdir/bin/caffeine" --version || true
          else
            echo "WARN: expected $tmpdir/bin/caffeine to exist; listing bundle contents:"
            find "$tmpdir" -maxdepth 2 -type f -or -type l -or -type d | sed 's|^|  |'
          fi

          shasum -a 256 "${out}" > "${out}.sha256"
          echo "ASSET=${out}" >> "$GITHUB_ENV"
          echo "ASSET_SHA256=${out}.sha256" >> "$GITHUB_ENV"

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.ASSET }}
            ${{ env.ASSET_SHA256 }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
